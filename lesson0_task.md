# Коммуникации систем

Учебный проект на курсе "Коммуникации систем".

## Контекст и проблема, которую нужно решать

Руководство Happy Cat Box (HCB) придумало повышать квалификацию своих сотрудников. Для этого им нужны учителя, которые будут заниматься с сотрудниками. Чтобы найти учителей, менеджеры опубликовали тендер на создание системы для автоматизации поиска. Тендер выиграла компания попугаев, полгода работала по ТЗ и в итоге выкатила систему, которая работает как ожидается, но ей неудобно пользоваться ни ученикам, ни учителям.
Команда попугаев отказалась дорабатывать систему и ушла за следующим тендером. Поэтому решать возникшие проблемы придётся вам.

## Изначальные требования для первых подрядчиков-попугаев

В каждом требовании есть идентификатор [US-XXX], где US — user story, а ХХХ — номер, чтобы было проще находить и обсуждать конкретное требование.

### Создание заданий для будущих учителей и управление ими

- [US-010] Менеджеры регистрируют новые задания для проверки компетенций кандидатов в учителя. Они это делают в отдельном уже готовом сервисе.
- [US-020] Менеджеры могут поменять условия созданных заданий. Это нужно для исправления ошибок или усложнения слишком простых заданий.
- [US-030] Если задание выполнили десять раз подряд — его нужно усложнить. В таком случае назначается менеджер для переделки. Назначенный менеджер редактирует назначенное задание через функцию редактирования заданий из [US-020].
- [US-040] Созданное или отредактированное задание продаётся в сторонний сервис найма. У нас нет к нему доступа, мы просто отправляем данные по http API. Это помогает зарабатывать деньги, которыми оплачивается работа менеджеров. Как зарабатывать — неважно, там NDA.


### Найм учителей

- [US-050] Потенциальный учитель самостоятельно регистрируется на платформе и после получает логин и пароль, по которым может войти в систему.
- [US-060] Потенциальный учитель может залогиниться в личный кабинет, где он будет выполнять задания. 
- [US-061] Аутентификация базовая через login/password .
- [US-070] Менеджер назначает задания для кандидатов в учителя. Неважно, как происходит выбор заданий, достаточно сделать кнопку «Назначить на кандидата ХХХ». Список заданий создаётся в сервисе «Создание заданий для будущих учителей и управление ими».
- [US-071] Задания для кандидата в учителя появляются только после назначения менеджером. До этого момента кандидат ждет задания.
- [US-080] Потенциальный учитель отправляет решение задания в форму, где система автоматически его проверяет и выдаёт оценку, правильно выполнено задание или нет.
- [US-090] Если задание выполнено правильно, то кандидат становится учителем и автоматически попадает в систему, которую делают Ибрагим с Олегом в уроках.
- [US-100] Система автоматически считает рейтинг задания по общему количеству правильных и неправильных ответов по формуле: rating = success_answers_count / total_answers_count. Результат округляется до первого знака после запятой: 0, 0.1, 0.2, 0.3 и так далее вплоть до 1 .

### Расчёт бонусов менеджеров

- [US-110] Менеджерам начисляются бонусы за созданное задание и правильное выполнение задания потенциальным учителем. Количество бонусов зависит от рейтинга задания.
- [US-111] Рейтинг для начисления бонусов всегда должен быть максимально актуальным на момент начисления средств
- [US-120] Начисление и списание бонусов зависят от рейтинга. Если рейтинг 0 или 1 — начисляется 1%, если в промежутке между этими двумя числами (от 0.1 до 0.9) — начисляется 100% бонуса.
- [US-130] Бонусы списываются за неправильное выполнение задания кандидатом в учителя. Рейтинг в этом случае учитывать не нужно.
- [US-140] Значения для зачисления и списания бонусов — фиксированные (кроме ситуации с рейтингом заданий). Начисляется всегда 100 y.e., а списывается 500 y.e.
- [US-150] Раз в месяц происходит выплата средств: учитывается весь менеджерский баланс. Для выплат — сторонний сервис с финансовыми транзакциями.
- [US-151] После выплаты баланс обнуляется. 
- [US-152] Если баланс отрицательный, то ничего не выплачивается, баланс не обнуляется.


## Как проект работает на текущий момент

Сейчас есть три сервиса:

1. найм учителей;
2. управление заданиями для найма, с которым взаимодействуют менеджеры;
3. расчёт бонусов для менеджеров.
   
Три сервиса всех устраивают, и менять в сервисах никто ничего не хочет. Это значит, что границы сервисов должны остаться такими, какие есть. А также запрещено добавлять новые требования или менять существующие.

Кроме набора сервисов есть схема коммуникаций между ними (см. CS_homework_-_system_communications_fLcmG45.pdf)

В схеме восемь связей.

| Номер связи | Название связи | Зачем связь нужна | Как реализована коммуникация | Откуда, куда, как часто |
|---|---|---|---|---|
| [COMM-010] | Получение информации о менеджере | Получать информацию о менеджерах | HTTP-вызов | Из сервиса найма запрос в сервис менеджмента заданий |
| [COMM-020] | Получение информации о задании | Получать информацию о задании, чтобы его использовать в бизнес-логике сервиса найма. UPDATED: задание запрашивается каждый раз по новому. Причем сервис найма получает уже назначенные задания | HTTP-вызов | Из сервиса найма синхронный запрос в сервис менеджмента. Каждый раз, когда нужно получить информацию об уроке |
| [COMM-030] | Назначение менеджера на переделку задания | Запускать процесс поиска менеджера, который переделает слишком лёгкое задание | HTTP-вызов | Из сервиса найма синхронный запрос в сервис менеджмента. Каждый раз, когда задание выполнили правильно 10 раз подряд |
| [COMM-040] | Зачисление бонусов на счёт менеджера | Зачислять бонусы на счёт менеджера, чьё задание правильно выполнил кандидат в учителя | HTTP-вызов | Из сервиса найма запрос в сервис бонусов |
| [COMM-050] | Списание средств со счёта менеджера | Списывать бонусы со счёта менеджера, чьё задание неправильно выполнил кандидат в учителя | HTTP-вызов | Из сервиса найма запрос в сервис бонусов |
| [COMM-060] | Отправка события TaskRating | Сообщать актуальный рейтинг задачи | Асинхронная отправка события через kafka (топик: task) | Из сервиса найма событие в сервис бонусов |
| [COMM-070] | Получение информации о менеджере | Получить информацию о менеджерах | HTTP-вызов | Из сервиса бонусов запрос в сервис менеджмента заданий |
| [COMM-080] | Зачисление средств на счёт менеджера | Зачислить бонусы на счёт менеджеру, который сделает новое задание (UPDATED) | HTTP-вызов | Из сервиса менеджмента заданий запрос в сервис бонусов |
| [COMM-090] | Получение списка кандидатов в учителя, которым будут назначаться задачи | Для выбора задач для кандидатов, необходимо получить список кандидатов, который реализуется этой связью | HTTP-вызов | Из сервиса менеджмента синхронный запрос в сервис найма за получением списка всех кандидатов, которые не прошли отбор. Каждый раз, когда надо назначить задачи кандидатам в учителя |

## Список проблем, которые возникли у бизнеса

В ходе обсуждения работы системы бизнес составил список проблем, которые требуют решения. Каждая проблема-требование состоит из идентификатора [Problem-XXX], где ХХХ — номер:

- [Problem-010] Долго определяется правильность выполнения задания от кандидата. Это вызывает задержки, которые бесят менеджеров и кандидатов в учителя.
- [Problem-020] Кандидаты в учителя читерят систему в месте, где простое задание должно усложниться, но этого ещё не произошло. Для этого они собираются в группы, где делятся лёгкими заданиями между собой, и, пока задание обновляется, пачкой выполняют лёгкие версии.
- [Problem-021] Главная проблема тут в том, что нужно как можно быстрее менять задание для кандидатов в учителя, после того, как менеджер поправит задание.
- [Problem-030] Логика начисления бонусов некорректна из-за ошибки с рейтингом задания. Во время начисления бонусов во время изменения рейтинга, происходит задержка, которая не удовлетворяет бизнес (нужно моментально).
- [Problem-040] Медленно начисляются бонусы менеджерам, потому что много кандидатов в учителя. Иногда вся система падает и не восстанавливается.
- [Problem-050] В UI может отобразиться ошибка каких-то запросов после успешного выполнения задания. Разработчики объясняют это поведение вызовом сервиса оплаты и создания заданий.
- [Problem-060] Нужно сократить расходы на скейлинг сервиса заданий. Сейчас дорого.
- [Problem-070] Менеджерам иногда начисляются бонусы дважды. Это связано с тем, что, когда кандидаты в учителя отправляют то же самое задание повторно, система тупит [Problem-050]. Разработчики объясняют тем, что управление заданиями падает, а бонусами — нет. Из-за этого бонусы попадают в два одинаковых запроса.
- [Problem-080] Упавший сервис создания заданий или бонусов кладёт всю систему, и кандидаты в учителя не могут выполнять задания.
- [Problem-090] Фичи выходят слишком медленно. Это связано с тем, что для выполнения любой фичи нужно изучить всю систему и проверить, что ничего не упало. Короче, разработчики сами не понимают, как работает система вне отдельного сервиса.
- [Problem-100] Данные теряются вокруг логики выполнения заданий кандидатами в учителя.
- [Problem-101] В системе нет никакой обработки ошибок и инструментов, связанных с ретраями и прочим. Единственное — сам брокер работает корректно, а проблемы могут возникнуть только либо в момент продьюсинга, либо в момент консьюминга событий.
При этом бизнес устраивает, что сейчас система состоит из трёх сервисов. Не нужно менять сервисы и их границы, потому что бизнес планирует расширяться.
